<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NARBE Benny's Access Hub</title>
  <meta name="description" content="NARBE House Hub for 2-button switch access." />
  <style>
    :root{
      --narbe-orange:#ff5c00;
      --narbe-blue:#5bb0ff;
      --bg:#0b0f14;
      --card:#121822;
      --text:#e8f0ff;
      --muted:#b6c6dd;
      --focus:#ffffff;
      --ring: 0 0 0 4px rgba(91,176,255,.55), 0 10px 25px rgba(0,0,0,.35);
      --radius: 18px;
    }

    /* Text Color variations */
    body.text-green {
      --narbe-orange: #00ff88;
      --narbe-blue: #00cc99;
    }
    body.text-purple {
      --narbe-orange: #9d4edd;
      --narbe-blue: #c77dff;
    }
    body.text-red {
      --narbe-orange: #ff006e;
      --narbe-blue: #ff5a8d;
    }
    body.text-gold {
      --narbe-orange: #ffb703;
      --narbe-blue: #fb8500;
    }
    body.text-black {
      --narbe-orange: #333333;
      --narbe-blue: #666666;
    }
    body.text-white {
      --narbe-orange: #ffffff;
      --narbe-blue: #f0f0f0;
    }

    /* Highlight Color variations */
    body.highlight-blue .card-btn:focus-visible,
    body.highlight-blue .backbtn:focus-visible,
    body.highlight-blue .modal-btn:focus-visible,
    body.highlight-blue .iframe-back:focus-visible,
    body.highlight-blue .nav-btn:focus-visible {
      box-shadow: 0 0 0 4px rgba(91,176,255,.55), 0 10px 25px rgba(0,0,0,.35);
    }
    body.highlight-green .card-btn:focus-visible,
    body.highlight-green .backbtn:focus-visible,
    body.highlight-green .modal-btn:focus-visible,
    body.highlight-green .iframe-back:focus-visible,
    body.highlight-green .nav-btn:focus-visible {
      box-shadow: 0 0 0 4px rgba(0,255,136,.55), 0 10px 25px rgba(0,0,0,.35);
    }
    body.highlight-purple .card-btn:focus-visible,
    body.highlight-purple .backbtn:focus-visible,
    body.highlight-purple .modal-btn:focus-visible,
    body.highlight-purple .iframe-back:focus-visible,
    body.highlight-purple .nav-btn:focus-visible {
      box-shadow: 0 0 0 4px rgba(157,78,221,.55), 0 10px 25px rgba(0,0,0,.35);
    }
    body.highlight-red .card-btn:focus-visible,
    body.highlight-red .backbtn:focus-visible,
    body.highlight-red .modal-btn:focus-visible,
    body.highlight-red .iframe-back:focus-visible,
    body.highlight-red .nav-btn:focus-visible {
      box-shadow: 0 0 0 4px rgba(255,0,110,.55), 0 10px 25px rgba(0,0,0,.35);
    }
    body.highlight-yellow .card-btn:focus-visible,
    body.highlight-yellow .backbtn:focus-visible,
    body.highlight-yellow .modal-btn:focus-visible,
    body.highlight-yellow .iframe-back:focus-visible,
    body.highlight-yellow .nav-btn:focus-visible {
      box-shadow: 0 0 0 4px rgba(255,183,3,.65), 0 10px 25px rgba(0,0,0,.35);
    }
    body.highlight-white .card-btn:focus-visible,
    body.highlight-white .backbtn:focus-visible,
    body.highlight-white .modal-btn:focus-visible,
    body.highlight-white .iframe-back:focus-visible,
    body.highlight-white .nav-btn:focus-visible {
      box-shadow: 0 0 0 4px rgba(255,255,255,.75), 0 10px 25px rgba(0,0,0,.35);
    }

    /* Background Theme variations - Dark modes */
    body.bg-ocean {
      background: #001a2e;
    }
    body.bg-forest {
      background: #0a1f0a;
    }
    body.bg-sunset {
      background: #1a0f0a;
    }
    body.bg-midnight {
      background: #0a0515;
    }
    body.bg-rose {
      background: #1a0a14;
    }

    /* Background Theme variations - Light modes */
    body.bg-sky {
      --text: #0a2540;
      --muted: #4a5f7a;
      background: #e0f2ff;
    }
    body.bg-sky .card-btn,
    body.bg-sky .backbtn,
    body.bg-sky .modal-content,
    body.bg-sky .nav-btn {
      background: linear-gradient(180deg, rgba(255,255,255,.8), rgba(255,255,255,.6));
      border-color: rgba(0,0,0,.15);
      box-shadow: 0 4px 16px rgba(0,0,0,.1);
    }
    body.bg-sky .notice {
      background: linear-gradient(135deg, rgba(255,92,0,.15), rgba(91,176,255,.15));
      border-color: rgba(0,0,0,.12);
    }

    body.bg-cream {
      --text: #2d1b00;
      --muted: #6b5d48;
      background: #fef9f0;
    }
    body.bg-cream .card-btn,
    body.bg-cream .backbtn,
    body.bg-cream .modal-content,
    body.bg-cream .nav-btn {
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,250,235,.7));
      border-color: rgba(101,67,33,.15);
      box-shadow: 0 4px 16px rgba(101,67,33,.12);
    }
    body.bg-cream .notice {
      background: linear-gradient(135deg, rgba(255,140,0,.12), rgba(210,180,140,.12));
      border-color: rgba(101,67,33,.12);
    }

    body.bg-mint {
      --text: #0d3d2d;
      --muted: #446854;
      background: #e8f8f5;
    }
    body.bg-mint .card-btn,
    body.bg-mint .backbtn,
    body.bg-mint .modal-content,
    body.bg-mint .nav-btn {
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(240,255,250,.7));
      border-color: rgba(0,100,80,.15);
      box-shadow: 0 4px 16px rgba(0,100,80,.1);
    }
    body.bg-mint .notice {
      background: linear-gradient(135deg, rgba(0,200,150,.1), rgba(100,220,200,.1));
      border-color: rgba(0,100,80,.12);
    }

    body.bg-lavender {
      --text: #2d1a40;
      --muted: #5c4a6b;
      background: #f5f0ff;
    }
    body.bg-lavender .card-btn,
    body.bg-lavender .backbtn,
    body.bg-lavender .modal-content,
    body.bg-lavender .nav-btn {
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(250,245,255,.7));
      border-color: rgba(75,0,130,.15);
      box-shadow: 0 4px 16px rgba(75,0,130,.1);
    }
    body.bg-lavender .notice {
      background: linear-gradient(135deg, rgba(138,43,226,.1), rgba(186,85,211,.1));
      border-color: rgba(75,0,130,.12);
    }

    body.bg-peach {
      --text: #3d1a0d;
      --muted: #6b4a3d;
      background: #fff5eb;
    }
    body.bg-peach .card-btn,
    body.bg-peach .backbtn,
    body.bg-peach .modal-content,
    body.bg-peach .nav-btn {
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,250,240,.7));
      border-color: rgba(139,69,19,.15);
      box-shadow: 0 4px 16px rgba(139,69,19,.1);
    }
    body.bg-peach .notice {
      background: linear-gradient(135deg, rgba(255,140,0,.12), rgba(255,160,122,.12));
      border-color: rgba(139,69,19,.12);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: var(--bg);
      display:flex;
      align-items: stretch;
      justify-content: center;
    }

    .container{
      width: min(1100px, 100%);
      padding: 24px clamp(16px, 3vw, 32px) 40px;
    }

    header{
      display:grid;
      gap: 10px;
      margin-bottom: 20px;
    }

    .brand{
      display:flex; align-items:center; gap:20px; flex-wrap:wrap; justify-content: space-between;
    }
    .brand-left{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap; flex: 1;
    }
    .logo{
      width:56px; height:56px; object-fit: contain;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,.4));
    }
    .benny-logo{
      width: 80px; height: 80px; object-fit: contain;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,.4));
      display: block;
      flex-shrink: 0;
    }
    .title {
      font-weight:800; letter-spacing:.3px; line-height:1.1; font-size: clamp(26px, 4vw, 40px);
    }
    .subtitle{ color:var(--muted); font-size: clamp(14px, 2.4vw, 16px); }

    .notice{
      padding: 16px 20px; border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(255,92,0,.08), rgba(91,176,255,.08));
      border: 1px solid rgba(255,255,255,.1);
      font-size: 14px; line-height: 1.5;
    }

    .screen{ 
      display:none; 
      outline: none;
    }
    .screen.active{ 
      display:block; 
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* Home screen layout */
    #screen-home .grid{
      grid-template-columns: repeat(3, 1fr);
      max-width: 100%;
    }
    @media (max-width: 900px){
      #screen-home .grid{ grid-template-columns: 1fr; }
    }

    /* Settings screen layout */
    #screen-settings .grid{
      grid-template-columns: repeat(3, 1fr);
      max-width: 100%;
    }
    @media (max-width: 900px){
      #screen-settings .grid{ grid-template-columns: 1fr; }
    }

    .card-btn{
      display:flex; flex-direction:column; justify-content:space-between; gap:12px;
      padding:22px; width:100%; text-align:left; cursor:pointer;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      outline: none;
      transition: transform .08s ease, box-shadow .08s ease, background .2s ease;
      color: var(--text);
    }
    .card-btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }
    .card-btn:focus-visible{
      box-shadow: var(--ring);
    }

    .kicker{
      font-size:12px; letter-spacing: .14em; text-transform: uppercase;
      color: var(--muted);
    }
    .btn-title{
      font-size: clamp(18px, 3vw, 24px); font-weight:800; line-height:1.1;
      background: linear-gradient(90deg, var(--narbe-orange), var(--narbe-blue));
      -webkit-background-clip:text; background-clip:text; color: transparent;
    }
    .desc{ color: var(--muted); font-size: 14px; }

    .row{
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .pill{
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700;
      color:#082032; background: linear-gradient(90deg, var(--narbe-blue), var(--narbe-orange));
      border:1px solid rgba(255,255,255,.2);
    }

    .footer-note{ margin-top:22px; color: var(--muted); font-size:13px; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0f1724; border:1px solid rgba(255,255,255,.18); padding:2px 6px; border-radius:6px; color:#d3e3ff; }

    .controls-bar{
      display:flex; gap:10px; margin: 8px 0 16px 0; align-items:center; flex-wrap:wrap;
      justify-content: space-between;
    }
    .controls-left{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .controls-right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .nav-btn{
      appearance:none; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03); color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
      transition: all .2s ease; outline: none;
    }
    .nav-btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.05);
    }
    .nav-btn:focus-visible{ box-shadow: var(--ring); }
    .nav-btn:disabled{
      opacity: .5; cursor: not-allowed;
    }

    .backbtn{ 
      appearance:none; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03); color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    .backbtn:focus-visible{ box-shadow: var(--ring); }

    .page-info{
      color: var(--muted); font-size: 14px; font-weight: 600;
    }

    .genre-filter{
      color: var(--text); font-size: 14px; font-weight: 600;
    }

    /* Visually hidden, but screen-reader available */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* Fullscreen Modal */
    .modal-overlay{
      position: fixed; inset: 0; background: rgba(0,0,0,.85);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; backdrop-filter: blur(8px);
    }
    .modal-overlay.hidden{ display: none; }
    .modal-content{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    .modal-title{
      font-size: 28px; font-weight: 800; margin: 0 0 12px 0;
      background: linear-gradient(90deg, var(--narbe-orange), var(--narbe-blue));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .modal-text{
      color: var(--muted); margin: 0 0 24px 0; line-height: 1.5;
    }
    .modal-buttons{
      display: flex; gap: 12px; justify-content: flex-end;
    }
    .modal-btn{
      padding: 12px 24px; border-radius: 12px; font-weight: 700;
      cursor: pointer; border: 1px solid rgba(255,255,255,.12);
      transition: all .2s ease; outline: none;
    }
    .modal-btn.primary{
      background: linear-gradient(90deg, var(--narbe-orange), var(--narbe-blue));
      color: #0b0f14; border-color: transparent;
    }
    .modal-btn.secondary{
      background: rgba(255,255,255,.03); color: var(--text);
    }
    .modal-btn:hover{ transform: translateY(-2px); }
    .modal-btn:focus-visible{ box-shadow: var(--ring); }

    /* Iframe Container */
    .iframe-container{
      position: fixed; inset: 0; background: var(--bg);
      z-index: 9000; display: none; flex-direction: column;
    }
    .iframe-container.active{ display: flex; }
    .iframe-header{
      display: flex; align-items: center; gap: 12px;
      padding: 16px 24px; background: rgba(0,0,0,.3);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .iframe-back{
      appearance: none; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03); color: var(--text);
      padding: 10px 14px; border-radius: 12px; font-weight: 700;
      cursor: pointer; outline: none;
    }
    .iframe-back:focus-visible{ box-shadow: var(--ring); }
    .iframe-title{
      font-weight: 800; font-size: 18px;
      background: linear-gradient(90deg, var(--narbe-orange), var(--narbe-blue));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .iframe-wrapper{
      flex: 1; position: relative; overflow: hidden;
    }
    .iframe-wrapper iframe{
      position: absolute; inset: 0; width: 100%; height: 100%;
      border: none; background: white;
    }

    /* Settings specific styles */
    .setting-item {
      display: flex; justify-content: space-between; align-items: center;
        padding: 18px; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      margin-bottom: 12px;
    }
    .setting-label {
      font-weight: 700; font-size: 16px;
    }
    .setting-value {
      font-size: 14px; color: var(--muted);
    }
    .toggle-btn {
      padding: 8px 16px; border-radius: 8px; font-weight: 600;
      background: linear-gradient(90deg, var(--narbe-orange), var(--narbe-blue));
      color: #0b0f14; border: none; cursor: pointer;
    }

    /* Genre filter screen */
    #screen-genre-filter .grid{
      max-width: 720px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <!-- Fullscreen Prompt Modal -->
  <div class="modal-overlay" id="fullscreen-modal">
    <div class="modal-content">
      <h2 class="modal-title">Use Fullscreen for the Best Experience</h2>
      <p class="modal-text">For optimal accessibility and immersion, we recommend using fullscreen mode.</p>
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="modal-cancel">Cancel</button>
        <button class="modal-btn primary" id="modal-fullscreen">Fullscreen</button>
      </div>
    </div>
  </div>

  <!-- Iframe Container -->
  <div class="iframe-container" id="iframe-container">
    <div class="iframe-header">
      <button class="iframe-back" id="iframe-back">← Back</button>
      <div class="iframe-title" id="iframe-title">Tool</div>
    </div>
    <div class="iframe-wrapper">
      <iframe id="app-iframe" title="Embedded tool" allow="fullscreen"></iframe>
    </div>
  </div>

  <a class="sr-only" href="#main">Skip to main content</a>
  <div class="container">
    <header>
      <div class="brand" aria-label="NARBE brand header">
        <div class="brand-left">
          <div>
            <div class="title">NARBE House | Benny's Accessibility Hub</div>
            <div class="subtitle">This is a hub for 2-button switch access mapped to spacebar and return and/or your mouse/headtracking/eyetracking.</div>
          </div>
        </div>
        <img src="images/BeaminBenny.png" 
             srcset="images/BeaminBenny.png 1x, ./images/BeaminBenny.png 2x"
             onerror="console.error('Failed to load Benny logo. Trying alternative paths...'); 
                      if(this.src.indexOf('./') !== 0) { 
                        this.src = './images/BeaminBenny.png'; 
                      } else if(window.location.hostname.includes('github')) { 
                        this.src = '/bennyshub/images/BeaminBenny.png'; 
                      } else { 
                        this.style.border='2px dashed var(--narbe-orange)'; 
                        this.alt='[Benny Logo Missing - Check images/BeaminBenny.png]'; 
                        this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22 viewBox=%220 0 80 80%22%3E%3Crect width=%2280%22 height=%2280%22 fill=%22%23ff5c00%22 opacity=%220.2%22 rx=%228%22/%3E%3Ctext x=%2240%22 y=%2245%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2214%22 fill=%22%23ff5c00%22%3EBenny%3C/text%3E%3C/svg%3E';
                      }" 
             onload="console.log('Benny logo loaded successfully from:', this.src);"
             alt="Beamin Benny" 
             class="benny-logo" />
      </div>
      <div class="notice" role="note">
        Below are tools and games that will be populated over time that are free to access and use. Use <span class="kbd">spacebar</span> to scan and <span class="kbd">return</span> to select. Mouse clicks work too.
      </div>
    </header>

    <main id="main" tabindex="-1">
      <!-- HOME SCREEN -->
      <section id="screen-home" class="screen active" aria-labelledby="home-heading" data-screen="home" tabindex="-1">
        <h2 id="home-heading" class="sr-only">Main menu</h2>
        <div class="grid" role="group" aria-label="Main menu buttons">
          <button class="card-btn nav" data-target="tools">
            <span class="kicker">Menu</span>
            <div class="btn-title">Tools</div>
            <div class="row">
              <p class="desc">Keyboard and Phrase Board. Free to use.</p>
              <span class="pill">Open</span>
            </div>
          </button>

          <button class="card-btn nav" data-target="games">
            <span class="kicker">Menu</span>
            <div class="btn-title">Games</div>
            <div class="row">
              <p class="desc">Start with Benny's P3GL Game. More coming soon.</p>
              <span class="pill">Open</span>
            </div>
          </button>

          <button class="card-btn nav" data-target="settings">
            <span class="kicker">Menu</span>
            <div class="btn-title">Settings</div>
            <div class="row">
              <p class="desc">Customize your experience. Themes, voice, and more.</p>
              <span class="pill">Open</span>
            </div>
          </button>
        </div>
      </section>

      <!-- TOOLS SCREEN -->
      <section id="screen-tools" class="screen" aria-labelledby="tools-heading" data-screen="tools" tabindex="-1">
        <div class="controls-bar">
          <div class="controls-left">
            <button class="backbtn" data-target="home" aria-label="Back to main menu">← Back</button>
            <button class="nav-btn" id="tools-filter-btn">Filter by Genre</button>
          </div>
          <div class="controls-right">
            <span class="page-info" id="tools-page-info">Page 1 of 1</span>
            <button class="nav-btn" id="tools-prev" disabled>← Previous</button>
            <button class="nav-btn" id="tools-next" disabled>Next →</button>
          </div>
        </div>
        <h2 id="tools-heading" class="sr-only">Tools</h2>
        <div class="grid" role="group" aria-label="Tools list" id="tools-grid">
          <!-- Tools will be populated by JavaScript -->
        </div>
        <p class="footer-note">Press <span class="kbd">spacebar</span> to move focus. Press <span class="kbd">return</span> to open a tool. Use the Back button to return here.</p>
      </section>

      <!-- GAMES SCREEN -->
      <section id="screen-games" class="screen" aria-labelledby="games-heading" data-screen="games" tabindex="-1">
        <div class="controls-bar">
          <div class="controls-left">
            <button class="backbtn" data-target="home" aria-label="Back to main menu">← Back</button>
            <button class="nav-btn" id="games-filter-btn">Filter by Genre</button>
          </div>
          <div class="controls-right">
            <span class="page-info" id="games-page-info">Page 1 of 1</span>
            <button class="nav-btn" id="games-prev" disabled>← Previous</button>
            <button class="nav-btn" id="games-next" disabled>Next →</button>
          </div>
        </div>
        <h2 id="games-heading" class="sr-only">Games</h2>
        <div class="grid" role="group" aria-label="Games list" id="games-grid">
          <!-- Games will be populated by JavaScript -->
        </div>
        <p class="footer-note">Press <span class="kbd">spacebar</span> to move focus. Press <span class="kbd">return</span> to launch the game. Use the Back button to return here.</p>
      </section>

      <!-- GENRE FILTER SCREEN -->
      <section id="screen-genre-filter" class="screen" aria-labelledby="genre-filter-heading" data-screen="genre-filter" tabindex="-1">
        <div class="controls-bar">
          <div class="controls-left">
            <button class="backbtn" id="genre-back-btn" aria-label="Back to previous menu">← Back</button>
          </div>
          <div class="controls-right">
            <span class="genre-filter" id="current-filter">All Items</span>
          </div>
        </div>
        <h2 id="genre-filter-heading" class="sr-only">Filter by Genre</h2>
        <div class="grid" role="group" aria-label="Genre filter options" id="genre-grid">
          <!-- Genre options will be populated by JavaScript -->
        </div>
        <p class="footer-note">Press <span class="kbd">spacebar</span> to move focus. Press <span class="kbd">return</span> to select a genre filter.</p>
      </section>

      <!-- SETTINGS SCREEN -->
      <section id="screen-settings" class="screen" aria-labelledby="settings-heading" data-screen="settings" tabindex="-1">
        <div class="controls-bar">
          <div class="controls-left">
            <button class="backbtn" data-target="home" aria-label="Back to main menu">← Back</button>
          </div>
        </div>
        <h2 id="settings-heading" class="sr-only">Settings</h2>
        <div class="grid" role="group" aria-label="Settings list">
          <button class="card-btn" id="highlight-toggle">
            <span class="kicker">Setting</span>
            <div class="btn-title">Highlight Color</div>
            <div class="row">
              <p class="desc">Change focus highlight color</p>
              <span class="pill" id="highlight-status">Blue</span>
            </div>
          </button>

          <button class="card-btn" id="textcolor-toggle">
            <span class="kicker">Setting</span>
            <div class="btn-title">Text Color</div>
            <div class="row">
              <p class="desc">Change text color scheme</p>
              <span class="pill" id="textcolor-status">Default</span>
            </div>
          </button>

          <button class="card-btn" id="bgtheme-toggle">
            <span class="kicker">Setting</span>
            <div class="btn-title">Background Theme</div>
            <div class="row">
              <p class="desc">Change background colors</p>
              <span class="pill" id="bgtheme-status">Default</span>
            </div>
          </button>

          <button class="card-btn" id="tts-toggle">
            <span class="kicker">Setting</span>
            <div class="btn-title">Text-to-Speech</div>
            <div class="row">
              <p class="desc">Enable spoken feedback</p>
              <span class="pill" id="tts-status">On</span>
            </div>
          </button>

          <button class="card-btn" id="voice-toggle">
            <span class="kicker">Setting</span>
            <div class="btn-title">Voice</div>
            <div class="row">
              <p class="desc">Change TTS voice</p>
              <span class="pill" id="voice-status">Default</span>
            </div>
          </button>

          <button class="card-btn" id="autoscan-toggle">
            <span class="kicker">Setting</span>
            <div class="btn-title">Auto Scan</div>
            <div class="row">
              <p class="desc">Automatically move focus every 2 seconds</p>
              <span class="pill" id="autoscan-status">Off</span>
            </div>
          </button>
        </div>
        <p class="footer-note">Press <span class="kbd">spacebar</span> to move focus. Press <span class="kbd">return</span> to toggle settings. Use the Back button to return home.</p>
      </section>

      <!-- Live polite announcements for screen-reader users -->
      <div aria-live="polite" aria-atomic="true" class="sr-only" id="live"></div>
    </main>
  </div>

  <!-- Include shared voice manager -->
  <script src="../shared/voice-manager.js"></script>
  
  <script>
    /**
     * NARBE Accessibility Hub
     * JSON-based app management with pagination and genre filtering
     */

    const SCREENS = {
      home: document.getElementById('screen-home'),
      tools: document.getElementById('screen-tools'),
      games: document.getElementById('screen-games'),
      settings: document.getElementById('screen-settings'),
      'genre-filter': document.getElementById('screen-genre-filter'),
    };

    const live = document.getElementById('live');
    const fullscreenModal = document.getElementById('fullscreen-modal');
    const modalFullscreenBtn = document.getElementById('modal-fullscreen');
    const modalCancelBtn = document.getElementById('modal-cancel');
    const iframeContainer = document.getElementById('iframe-container');
    const iframeBack = document.getElementById('iframe-back');
    const iframeTitle = document.getElementById('iframe-title');
    const appIframe = document.getElementById('app-iframe');

    // App data and state
    let appsData = { tools: [], games: [] };
    let currentScreen = 'home';
    let filterState = {
      tools: { genre: 'all', page: 0 },
      games: { genre: 'all', page: 0 }
    };
    const ITEMS_PER_PAGE = 9;

    // Settings state
    let settings = {
      highlightColor: 'blue',
      textColor: 'default',
      bgTheme: 'default',
      autoScan: false,
    };

    // Auto scan state
    let autoScanInterval = null;
    let spaceHoldTimeout = null;
    let backwardsScanInterval = null;
    let spaceHoldStartTime = 0;
    const AUTO_SCAN_DELAY = 2000; // 2 seconds
    const BACKWARDS_SCAN_THRESHOLD = 3000; // 3 seconds to trigger backwards scan
    const BACKWARDS_SCAN_INTERVAL = 1500; // 1.5 seconds between backwards scans

    // Load JSON data for apps
    async function loadAppsData() {
      try {
        const [toolsResponse, gamesResponse] = await Promise.all([
          fetch('apps/tools/tools.json'),
          fetch('apps/games/games.json')
        ]);
        
        const toolsData = await toolsResponse.json();
        const gamesData = await gamesResponse.json();
        
        appsData.tools = toolsData.tools.sort((a, b) => a.title.localeCompare(b.title));
        appsData.games = gamesData.games.sort((a, b) => a.title.localeCompare(b.title));
        
        console.log('Apps data loaded:', appsData);
      } catch (error) {
        console.error('Failed to load apps data:', error);
        // Fallback to empty arrays
        appsData = { tools: [], games: [] };
      }
    }

    // Get unique genres for a category
    function getGenres(category) {
      const items = appsData[category] || [];
      const genreSet = new Set();
      items.forEach(item => {
        if (item.genres) {
          item.genres.forEach(genre => genreSet.add(genre));
        }
      });
      return Array.from(genreSet).sort();
    }

    // Filter items by genre
    function filterItemsByGenre(category, genre) {
      const items = appsData[category] || [];
      
      if (genre === 'all' || !genre) {
        return items.sort((a, b) => a.title.localeCompare(b.title));
      }
      return items.filter(item => item.genres && item.genres.includes(genre))
                  .sort((a, b) => a.title.localeCompare(b.title));
    }

    // Paginate items
    function paginateItems(items, page) {
      const startIndex = page * ITEMS_PER_PAGE;
      const endIndex = startIndex + ITEMS_PER_PAGE;
      return {
        items: items.slice(startIndex, endIndex),
        totalPages: Math.ceil(items.length / ITEMS_PER_PAGE),
        currentPage: page + 1,
        hasNext: endIndex < items.length,
        hasPrevious: page > 0
      };
    }

    // Create app card HTML
    function createAppCard(app, category) {
      const categoryLabel = category === 'tools' ? 'Tool' : 'Game';
      const actionLabel = category === 'tools' ? 'Launch' : 'Play';
      
      return `
        <button class="card-btn app-btn" data-path="${app.path}" data-title="${app.title}">
          <span class="kicker">${categoryLabel}</span>
          <div class="btn-title">${app.title}</div>
          <div class="row">
            <p class="desc">${app.description}</p>
            <span class="pill">${actionLabel}</span>
          </div>
        </button>
      `;
    }

    // Create genre filter card HTML
    function createGenreCard(genre, isAll = false) {
      return `
        <button class="card-btn genre-btn" data-genre="${genre}">
          <span class="kicker">Filter</span>
          <div class="btn-title">${genre}</div>
          <div class="row">
            <p class="desc">${isAll ? 'Show all items' : `Show ${genre.toLowerCase()} items only`}</p>
            <span class="pill">Select</span>
          </div>
        </button>
      `;
    }

    // Render apps grid
    function renderAppsGrid(category) {
      const grid = document.getElementById(`${category}-grid`);
      const pageInfo = document.getElementById(`${category}-page-info`);
      const prevBtn = document.getElementById(`${category}-prev`);
      const nextBtn = document.getElementById(`${category}-next`);
      
      const state = filterState[category];
      const filteredItems = filterItemsByGenre(category, state.genre);
      const paginatedData = paginateItems(filteredItems, state.page);
      
      // Update grid
      const gridHTML = paginatedData.items.map(app => createAppCard(app, category)).join('');
      grid.innerHTML = gridHTML;
      
      // Update page info
      if (paginatedData.totalPages > 0) {
        pageInfo.textContent = `Page ${paginatedData.currentPage} of ${paginatedData.totalPages}`;
      } else {
        pageInfo.textContent = 'No items found';
      }
      
      // Update navigation buttons
      prevBtn.disabled = !paginatedData.hasPrevious;
      nextBtn.disabled = !paginatedData.hasNext;
      
      // Add event listeners to app buttons
      grid.querySelectorAll('.app-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const path = btn.getAttribute('data-path');
          const title = btn.getAttribute('data-title');
          speak(`Opening ${title}`);
          showIframe(path, title);
        });
      });
      
      // Reset focus when grid changes
      focusIndex = -1;
    }

    // Render genre filter screen
    function renderGenreFilter(category, returnScreen) {
      const grid = document.getElementById('genre-grid');
      const currentFilter = document.getElementById('current-filter');
      const backBtn = document.getElementById('genre-back-btn');
      
      const genres = getGenres(category);
      const allGenres = ['All Items', ...genres];
      
      grid.innerHTML = allGenres.map((genre, index) => {
        const genreValue = index === 0 ? 'all' : genre;
        return `
          <button class="card-btn genre-btn" data-genre="${genreValue}">
            <span class="kicker">Filter</span>
            <div class="btn-title">${genre}</div>
            <div class="row">
              <p class="desc">${index === 0 ? 'Show all items' : `Show ${genre.toLowerCase()} items only`}</p>
              <span class="pill">Select</span>
            </div>
          </button>
        `;
      }).join('');
      
      currentFilter.textContent = filterState[category].genre === 'all' ? 'All Items' : filterState[category].genre;
      
      // Update back button target
      backBtn.setAttribute('data-target', returnScreen);
      backBtn.setAttribute('data-category', category);
      
      // Add event listeners to genre buttons
      grid.querySelectorAll('.genre-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const genre = btn.getAttribute('data-genre');
          const genreName = genre === 'all' ? 'All Items' : genre;
          
          filterState[category].genre = genre;
          filterState[category].page = 0; // Reset to first page
          
          speak(`Filter set to ${genreName}`);
          renderAppsGrid(category);
          showScreen(returnScreen);
        });
      });
      
      // Reset focus when screen changes
      focusIndex = -1;
    }

    // Load settings from localStorage
    function loadSettings() {
      const saved = localStorage.getItem('narbe-hub-settings');
      if (saved) {
        settings = { ...settings, ...JSON.parse(saved) };
        applySettings();
      }
    }

    function saveSettings() {
      localStorage.setItem('narbe-hub-settings', JSON.stringify(settings));
    }

    function applySettings() {
      // Apply highlight color
      document.body.className = document.body.className.replace(/highlight-\w+/g, '');
      document.body.classList.add(`highlight-${settings.highlightColor}`);
      const highlightNames = { blue: 'Blue', green: 'Green', purple: 'Purple', red: 'Red', yellow: 'Yellow', white: 'White' };
      document.getElementById('highlight-status').textContent = highlightNames[settings.highlightColor];

      // Apply text color
      document.body.className = document.body.className.replace(/text-\w+/g, '');
      if (settings.textColor !== 'default') {
        document.body.classList.add(`text-${settings.textColor}`);
      }
      const textColorNames = { default: 'Default', green: 'Green', purple: 'Purple', red: 'Red', gold: 'Gold', black: 'Black', white: 'White' };
      document.getElementById('textcolor-status').textContent = textColorNames[settings.textColor];

      // Apply background theme
      document.body.className = document.body.className.replace(/bg-\w+/g, '');
      if (settings.bgTheme !== 'default') {
        document.body.classList.add(`bg-${settings.bgTheme}`);
      }
      const bgThemeNames = { 
        default: 'Default', 
        ocean: 'Ocean', 
        forest: 'Forest', 
        sunset: 'Sunset', 
        midnight: 'Midnight', 
        rose: 'Rose',
        sky: 'Sky',
        cream: 'Cream',
        mint: 'Mint',
        lavender: 'Lavender',
        peach: 'Peach'
      };
      document.getElementById('bgtheme-status').textContent = bgThemeNames[settings.bgTheme];

      // Apply auto scan setting
      document.getElementById('autoscan-status').textContent = settings.autoScan ? 'On' : 'Off';
      if (settings.autoScan) {
        startAutoScan();
      } else {
        stopAutoScan();
      }

      // Apply TTS status (from voice manager)
      const voiceSettings = window.NarbeVoiceManager.getSettings();
      document.getElementById('tts-status').textContent = voiceSettings.ttsEnabled ? 'On' : 'Off';

      // Apply Voice display (from voice manager)
      updateVoiceDisplay();
    }

    // Auto scan functions
    function startAutoScan() {
      if (autoScanInterval) return; // Already running
      
      autoScanInterval = setInterval(() => {
        if (!isTransitioning && !iframeContainer.classList.contains('active') && fullscreenModal.classList.contains('hidden')) {
          focusNext();
        }
      }, AUTO_SCAN_DELAY);
    }

    function stopAutoScan() {
      if (autoScanInterval) {
        clearInterval(autoScanInterval);
        autoScanInterval = null;
      }
    }

    function focusPrevious() {
      const list = getFocusables();
      if(list.length === 0) return;
      
      if (focusIndex === -1) {
        focusIndex = list.length - 1;
        list[focusIndex].focus();
        speakFocusedElement(list[focusIndex]);
        return;
      }
      
      const currentFocused = document.activeElement;
      const currentIndex = list.indexOf(currentFocused);
      
      if (currentIndex >= 0) {
        focusIndex = currentIndex;
      }
      
      focusAt(focusIndex - 1);
    }

    // TTS functionality using unified voice manager
    function speak(text) {
      window.NarbeVoiceManager.speak(text);
    }

    function updateVoiceDisplay() {
      const currentVoice = window.NarbeVoiceManager.getCurrentVoice();
      const displayName = window.NarbeVoiceManager.getVoiceDisplayName(currentVoice);
      document.getElementById('voice-status').textContent = displayName;
    }

    // Update voice display when voice manager settings change
    window.NarbeVoiceManager.onSettingsChange(() => {
      updateVoiceDisplay();
      applySettings();
    });

    // Settings toggles
    document.getElementById('highlight-toggle').addEventListener('click', () => {
      const colors = ['blue', 'green', 'purple', 'red', 'yellow', 'white'];
      const currentIndex = colors.indexOf(settings.highlightColor);
      settings.highlightColor = colors[(currentIndex + 1) % colors.length];
      applySettings();
      saveSettings();
      speak(`Highlight color changed to ${settings.highlightColor}`);
    });

    document.getElementById('textcolor-toggle').addEventListener('click', () => {
      const textColors = ['default', 'green', 'purple', 'red', 'gold', 'black', 'white'];
      const currentIndex = textColors.indexOf(settings.textColor);
      settings.textColor = textColors[(currentIndex + 1) % textColors.length];
      applySettings();
      saveSettings();
      speak(`Text color changed to ${settings.textColor}`);
    });

    document.getElementById('bgtheme-toggle').addEventListener('click', () => {
      const bgThemes = ['default', 'ocean', 'forest', 'sunset', 'midnight', 'rose', 'sky', 'cream', 'mint', 'lavender', 'peach'];
      const currentIndex = bgThemes.indexOf(settings.bgTheme);
      settings.bgTheme = bgThemes[(currentIndex + 1) % bgThemes.length];
      applySettings();
      saveSettings();
      speak(`Background theme changed to ${settings.bgTheme}`);
    });

    document.getElementById('tts-toggle').addEventListener('click', () => {
      const ttsEnabled = window.NarbeVoiceManager.toggleTTS();
      applySettings();
      if (ttsEnabled) {
        speak('Text to speech enabled');
      }
    });

    document.getElementById('voice-toggle').addEventListener('click', () => {
      const voiceChanged = window.NarbeVoiceManager.cycleVoice();
      if (voiceChanged) {
        updateVoiceDisplay();
        applySettings();
        const currentVoice = window.NarbeVoiceManager.getCurrentVoice();
        const voiceName = window.NarbeVoiceManager.getVoiceDisplayName(currentVoice);
        speak(`Voice changed to ${voiceName}`);
      } else {
        speak('No voices available');
      }
    });

    document.getElementById('autoscan-toggle').addEventListener('click', () => {
      settings.autoScan = !settings.autoScan;
      applySettings();
      saveSettings();
      speak(`Auto scan ${settings.autoScan ? 'enabled' : 'disabled'}`);
    });

    // Fullscreen management
    function enterFullscreen() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
    }

    function closeModal() {
      fullscreenModal.classList.add('hidden');
    }

    modalFullscreenBtn.addEventListener('click', () => {
      enterFullscreen();
      closeModal();
    });

    modalCancelBtn.addEventListener('click', () => {
      closeModal();
    });

    // Show iframe with tool/game
    function showIframe(src, title) {
      iframeTitle.textContent = title;
      appIframe.src = src;
      iframeContainer.classList.add('active');
      iframeBack.focus();
      announce(`${title} loaded`);
      
      setTimeout(() => {
        try {
          appIframe.contentWindow.focus();
          
          if (window.NarbeVoiceManager) {
            const currentSettings = window.NarbeVoiceManager.getSettings();
            appIframe.contentWindow.postMessage({
              type: 'narbe-voice-settings-changed',
              settings: currentSettings
            }, '*');
          }
        } catch (e) {
          console.log('Unable to focus iframe content or send voice settings:', e);
        }
      }, 500);
    }

    function closeIframe() {
      iframeContainer.classList.remove('active');
      appIframe.src = '';
      focusIndex = -1;
      
      const activeScreen = document.querySelector('.screen.active');
      if (activeScreen) {
        activeScreen.focus();
        if (document.activeElement !== activeScreen) {
          document.getElementById('main').focus();
        }
      }
      
      announce('Returned to menu');
      speak('Returned to menu. Press spacebar to start scanning');
    }

    iframeBack.addEventListener('click', () => {
      speak('Closing app');
      closeIframe();
    });

    // Screen management
    function showScreen(name) {
      isTransitioning = true;
      currentScreen = name;
      
      for(const id in SCREENS){
        SCREENS[id].classList.toggle('active', id === name);
      }
      
      // Render content for dynamic screens
      if (name === 'tools') {
        renderAppsGrid('tools');
      } else if (name === 'games') {
        renderAppsGrid('games');
      }
      
      focusIndex = -1;
      spacePressed = false;
      enterPressed = false;
      
      setTimeout(() => {
        const activeScreen = document.querySelector('.screen.active');
        if (activeScreen) {
          activeScreen.focus();
          if (document.activeElement !== activeScreen) {
            document.getElementById('main').focus();
          }
        }
        
        announce(`${name} menu`);
        speak(`${name} menu. Press spacebar to start scanning`);
        isTransitioning = false;
      }, 100);
    }

    function announce(msg) {
      live.textContent = '';
      setTimeout(() => { live.textContent = msg; }, 10);
    }

    function getFocusables() {
      if (iframeContainer.classList.contains('active')) {
        return [iframeBack];
      }
      const active = document.querySelector('.screen.active');
      if(!active) return [];
      return Array.from(active.querySelectorAll('button:not([disabled])'))
        .filter(el => !el.hasAttribute('disabled'));
    }

    function speakFocusedElement(el) {
      if (!el) return;
      const titleEl = el.querySelector('.btn-title');
      let text = '';
      
      if (titleEl) {
        text = titleEl.textContent;
      } else if (el.classList.contains('backbtn')) {
        text = 'Back';
      } else if (el.classList.contains('nav-btn')) {
        text = el.textContent;
      } else {
        text = el.textContent.trim();
      }
      
      if (text) {
        speak(text);
      }
    }

    // Navigation event listeners
    document.querySelectorAll('.card-btn.nav').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-target');
        const titleEl = btn.querySelector('.btn-title');
        if (titleEl) {
          speak(`Opening ${titleEl.textContent}`);
        }
        showScreen(target);
      });
    });

    document.querySelectorAll('.backbtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-target') || 'home';
        speak('Going back');
        showScreen(target);
      });
    });

    // Pagination event listeners
    ['tools', 'games'].forEach(category => {
      document.getElementById(`${category}-prev`).addEventListener('click', () => {
        if (filterState[category].page > 0) {
          filterState[category].page--;
          renderAppsGrid(category);
          speak('Previous page');
        }
      });

      document.getElementById(`${category}-next`).addEventListener('click', () => {
        const filteredItems = filterItemsByGenre(category, filterState[category].genre);
        const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
        if (filterState[category].page < totalPages - 1) {
          filterState[category].page++;
          renderAppsGrid(category);
          speak('Next page');
        }
      });
    });

    // Filter button event listeners
    document.getElementById('games-filter-btn').addEventListener('click', () => {
      speak('Opening genre filter');
      renderGenreFilter('games', 'games');
      showScreen('genre-filter');
    });

    document.getElementById('tools-filter-btn').addEventListener('click', () => {
      speak('Opening genre filter');
      renderGenreFilter('tools', 'tools');
      showScreen('genre-filter');
    });

    // Keyboard scanning functionality
    let focusIndex = -1;
    let spacePressed = false;
    let enterPressed = false;
    let isTransitioning = false;
    let suppressEnterClick = false;
    let lastActivationTime = 0;
    const DEBOUNCE_DELAY = 500;

    function focusAt(idx) {
      const list = getFocusables();
      if(list.length === 0) return;
      focusIndex = ((idx % list.length) + list.length) % list.length;
      list[focusIndex].focus();
      speakFocusedElement(list[focusIndex]);
    }

    function focusNext() {
      const list = getFocusables();
      if(list.length === 0) return;
      
      if (focusIndex === -1) {
        focusIndex = 0;
        list[focusIndex].focus();
        speakFocusedElement(list[focusIndex]);
        return;
      }
      
      const currentFocused = document.activeElement;
      const currentIndex = list.indexOf(currentFocused);
      
      if (currentIndex >= 0) {
        focusIndex = currentIndex;
      }
      
      focusAt(focusIndex + 1);
    }

    function activateFocused() {
      if (isTransitioning) return;
      
      const currentTime = Date.now();
      if (currentTime - lastActivationTime < DEBOUNCE_DELAY) {
        return;
      }
      lastActivationTime = currentTime;
      
      const list = getFocusables();
      if(list.length === 0) return;
      
      if (focusIndex === -1) {
        speak('Press spacebar first to select an item');
        return;
      }
      
      const currentFocused = document.activeElement;
      const currentIndex = list.indexOf(currentFocused);
      
      if (currentIndex >= 0) {
        focusIndex = currentIndex;
      }
      
      const el = list[focusIndex];
      el.click();
    }

    // Keyboard event handlers
    document.addEventListener('keydown', (e) => {
      if (!fullscreenModal.classList.contains('hidden')) {
        if (e.key === ' ' && !spacePressed) {
          e.preventDefault();
          spacePressed = true;
        } else if ((e.key === 'Enter' || e.keyCode === 13) && !enterPressed) {
          e.preventDefault();
          enterPressed = true;
          suppressEnterClick = true;
        }
        return;
      }

      if (isTransitioning) {
        if (e.key === ' ' || e.key === 'Enter' || e.keyCode === 13) {
          e.preventDefault();
        }
        return;
      }

      const tag = document.activeElement?.tagName;
      if(tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement?.isContentEditable){
        return;
      }

      if(e.key === ' ' && !spacePressed){
        e.preventDefault();
        spacePressed = true;
        spaceHoldStartTime = Date.now();
        
        // Set timeout for backwards scanning
        spaceHoldTimeout = setTimeout(() => {
          if (spacePressed && !iframeContainer.classList.contains('active') && fullscreenModal.classList.contains('hidden')) {
            speak('Backwards scanning');
            focusPrevious();
            
            // Start backwards auto-scan
            backwardsScanInterval = setInterval(() => {
              if (spacePressed && !iframeContainer.classList.contains('active') && fullscreenModal.classList.contains('hidden')) {
                focusPrevious();
              } else {
                clearInterval(backwardsScanInterval);
                backwardsScanInterval = null;
              }
            }, BACKWARDS_SCAN_INTERVAL);
          }
        }, BACKWARDS_SCAN_THRESHOLD);
        
      } else if((e.key === 'Enter' || e.keyCode === 13) && !enterPressed){
        e.preventDefault();
        enterPressed = true;
        suppressEnterClick = true;
      }
    });

    document.addEventListener('click', (e) => {
      if (suppressEnterClick) {
        e.preventDefault();
        e.stopPropagation();
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
      }
    }, true);

    document.addEventListener('keyup', (e) => {
      if (!fullscreenModal.classList.contains('hidden')) {
        if (e.key === ' ' && spacePressed) {
          e.preventDefault();
          spacePressed = false;
          if (document.activeElement !== modalFullscreenBtn && document.activeElement !== modalCancelBtn) {
            modalFullscreenBtn.focus();
            speak('Fullscreen');
          } else if (document.activeElement === modalFullscreenBtn) {
            modalCancelBtn.focus();
            speak('Cancel');
          } else {
            modalFullscreenBtn.focus();
            speak('Fullscreen');
          }
        } else if ((e.key === 'Enter' || e.keyCode === 13) && enterPressed) {
          e.preventDefault();
          enterPressed = false;
          suppressEnterClick = false;
          if (document.activeElement === modalFullscreenBtn) {
            modalFullscreenBtn.click();
          } else if (document.activeElement === modalCancelBtn) {
            modalCancelBtn.click();
          } else {
            speak('Press spacebar first to select a button');
          }
        }
        return;
      }

      if (isTransitioning) {
        if (e.key === ' ') {
          spacePressed = false;
          // Clear timers
          if (spaceHoldTimeout) {
            clearTimeout(spaceHoldTimeout);
            spaceHoldTimeout = null;
          }
          if (backwardsScanInterval) {
            clearInterval(backwardsScanInterval);
            backwardsScanInterval = null;
          }
        }
        if (e.key === 'Enter' || e.keyCode === 13) {
          enterPressed = false;
          suppressEnterClick = false;
        }
        return;
      }

      const tag = document.activeElement?.tagName;
      if(tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement?.isContentEditable){
        return;
      }

      if(e.key === ' ' && spacePressed){
        e.preventDefault();
        spacePressed = false;
        
        // Clear backwards scanning timers
        if (spaceHoldTimeout) {
          clearTimeout(spaceHoldTimeout);
          spaceHoldTimeout = null;
        }
        if (backwardsScanInterval) {
          clearInterval(backwardsScanInterval);
          backwardsScanInterval = null;
        }
        
        // Check if this was a short press (normal forward scanning)
        const holdDuration = Date.now() - spaceHoldStartTime;
        if (holdDuration < BACKWARDS_SCAN_THRESHOLD) {
          focusNext();
        }
        
      } else if((e.key === 'Enter' || e.keyCode === 13) && enterPressed){
        e.preventDefault();
        enterPressed = false;
        suppressEnterClick = false;
        activateFocused();
      }
    });

    // Initialize application
    window.addEventListener('load', async () => {
      loadSettings();
      
      await loadAppsData();
      
      window.NarbeVoiceManager.waitForVoices().then(() => {
        updateVoiceDisplay();
        applySettings();
      });
      
      focusIndex = -1;
      
      document.body.focus();
      if (document.activeElement !== document.body) {
        document.getElementById('main').focus();
      }
      
      speak('Use Fullscreen for the Best Experience. Press spacebar to start');
    });

    // Listen for messages from iframe content
    window.addEventListener('message', (event) => {
      if (event.data && event.data.action === 'focusBackButton') {
        if (iframeContainer.classList.contains('active')) {
          closeIframe();
        }
      }
    });
  </script>
</body>
</html>

